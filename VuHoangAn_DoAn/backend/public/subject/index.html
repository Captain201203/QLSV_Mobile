<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý môn học</title>
    <style>
        body {font-family: Arial; margin: 20px;}
        table{border-collapse: collapse; width: 100%; margin-top: 20px;}
        th, td{border: 1px solid #ccc; padding: 8px; text-align: left;}
        th{background-color: #f0f0f0;}
        input, button, textarea { margin: 5px; padding: 5px}
        textarea { width: 300px; height: 60px; }
        .form-row { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Quản lý môn học</h2>
    <div>
        <div class="form-row">
            <input type="text" id="subjectId" placeholder="Mã môn học">
            <input type="text" id="subjectName" placeholder="Tên môn học">
        </div>
        <div class="form-row">
            <input type="number" id="credits" placeholder="Số tín chỉ" min="1" max="6">
            <input type="text" id="department" placeholder="Khoa/Bộ môn">
        </div>
        <div class="form-row">
            <textarea id="description" placeholder="Mô tả môn học (tùy chọn)"></textarea>
        </div>
        <button onclick="createSubject()">Thêm môn học</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Mã môn học</th>
                <th>Tên môn học</th>
                <th>Số tín chỉ</th>
                <th>Khoa/Bộ môn</th>
                <th>Mô tả</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody id="subjectTableBody"></tbody>
    </table>

    <script>
        const API_URL = 'http://localhost:3000/subjects';

        async function fetchSubjects(){
            try {
                const res = await fetch(API_URL);
                const subjects = await res.json();
                console.log("Dữ liệu môn học từ server:", subjects);
                
                const tbody = document.getElementById("subjectTableBody");
                tbody.innerHTML = '';

                subjects.forEach(subject => {
                    console.log("Xử lý môn học:", subject);
                    
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${subject.subjectId}</td>
                        <td>${subject.subjectName}</td>
                        <td>${subject.credits}</td>
                        <td>${subject.department}</td>
                        <td>${subject.description || 'Không có mô tả'}</td>
                        <td>
                            <button onclick="updateSubject('${subject._id}')">Sửa</button>
                            <button onclick="deleteSubject('${subject._id}')">Xóa</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Lỗi khi tải danh sách môn học:", error);
                alert("Không thể tải danh sách môn học");
            }
        }

        async function createSubject(){
            try {
                const data = {
                    subjectId: document.getElementById("subjectId").value.trim(),
                    subjectName: document.getElementById("subjectName").value.trim(),
                    credits: parseInt(document.getElementById("credits").value),
                    department: document.getElementById("department").value.trim(),
                    description: document.getElementById("description").value.trim() || undefined,
                };

                // Validation
                if (!data.subjectId || !data.subjectName || !data.credits || !data.department) {
                    alert("Vui lòng nhập đầy đủ thông tin bắt buộc (trừ mô tả)");
                    return;
                }

                if (data.credits < 1 || data.credits > 6) {
                    alert("Số tín chỉ phải từ 1 đến 6");
                    return;
                }

                console.log("Dữ liệu gửi đi:", data);

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                console.log("Phản hồi từ server:", result);

                if (!res.ok) {
                    throw new Error(result.message || "Không thể thêm môn học");
                }
                
                await fetchSubjects();
                alert("Thêm môn học thành công!");
                
                // Clear form
                document.getElementById("subjectId").value = '';
                document.getElementById("subjectName").value = '';
                document.getElementById("credits").value = '';
                document.getElementById("department").value = '';
                document.getElementById("description").value = '';
                
            } catch (err) {
                console.error("Lỗi:", err);
                alert("Lỗi khi thêm môn học: " + err.message);
            }
        }

        async function updateSubject(id){
            try {
                const newName = prompt("Nhập tên môn học mới:");
                if(!newName || !newName.trim()) return;
                
                const res = await fetch(`${API_URL}/${id}`, {
                    method: "PUT",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({subjectName: newName.trim()})
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || "Không thể cập nhật môn học");
                }

                await fetchSubjects();
                alert("Cập nhật thành công!");
            } catch (error) {
                console.error("Lỗi khi cập nhật:", error);
                alert("Lỗi khi cập nhật: " + error.message);
            }
        }

        async function deleteSubject(id){
            try {
                if(!confirm("Bạn có chắc muốn xóa môn học này không?")) return;
                
                const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || "Không thể xóa môn học");
                }

                await fetchSubjects();
                alert("Xóa thành công!");
            } catch (error) {
                console.error("Lỗi khi xóa:", error);
                alert("Lỗi khi xóa: " + error.message);
            }
        }

        // ✅ Gọi khi load trang
        fetchSubjects();
    </script>
</body>
</html>
